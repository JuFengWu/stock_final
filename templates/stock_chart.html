<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <title>Stock Chart with Highcharts</title>
</head>
<body>
    <h1>Stock Chart with Highcharts</h1>

    <!-- 用戶輸入區域 -->
    <form id="stockForm">
        <label for="stock_code">Stock Code:</label>
        <input type="text" id="stock_code" name="stock_code" value="AAPL" required><br><br>

        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date" name="start_date" value="2024-01-01" required><br><br>

        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" value="2024-12-31" required><br><br>

        <button type="button" id="fetchButton">Fetch Data</button>
    </form>

    <!-- Highcharts 繪圖容器 -->
    <div id="chartContainer" style="width: 800px; height: 500px; margin: 0 auto;"></div>

    <script>
        // Fetch API 數據的函數
        function fetchData() {
            const stockCode = document.getElementById("stock_code").value;
            const startDate = document.getElementById("start_date").value;
            const endDate = document.getElementById("end_date").value;

            fetch(`/api/stock-data/?stock_code=${stockCode}&start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    drawChart(data);
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }

        // 繪製 Highcharts K 線圖的函數
        function drawChart(data) {
            const ohlc = [];
            const entrySignals = [];
            const exitSignals = [];

            data.forEach(item => {
                const point = [
                    new Date(item.date).getTime(),
                    item.open,
                    item.high,
                    item.low,
                    item.close
                ];
                ohlc.push(point);

                if (item.entry_signal) {
                    entrySignals.push({
                        x: new Date(item.date).getTime(),
                        y: item.close,
                        title: '▲',
                        text: `Entry Signal: ${item.entry_signal}`,
                        color: '#FF0000'
                    });
                }

                if (item.exit_signal) {
                    exitSignals.push({
                        x: new Date(item.date).getTime(),
                        y: item.close,
                        title: '▼',
                        text: `Exit Signal: ${item.exit_signal}`,
                        color: '#00FF00'
                    });
                }
            });

            Highcharts.stockChart('chartContainer', {
                rangeSelector: {
                    selected: 1
                },
                title: {
                    text: `All`
                },
                tooltip: {
                    split: true
                },
                yAxis: {
                    title: {
                        text: 'Price'
                    }
                },
                series: [
                    {
                        type: 'candlestick',
                        id: 'ohlc-series',
                        name: 'OHLC',
                        data: ohlc,
                        tooltip: {
                            valueDecimals: 2
                        }
                    },
                    {
                        type: 'flags',
                        name: 'Entry Signals',
                        data: entrySignals,
                        onSeries: 'ohlc-series',
                        shape: 'circlepin',
                        width: 16,
                        color: '#FF0000',
                        fillColor: '#FF0000',
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    {
                        type: 'flags',
                        name: 'Exit Signals',
                        data: exitSignals,
                        onSeries: 'ohlc-series',
                        shape: 'circlepin',
                        width: 16,
                        color: '#00FF00',
                        fillColor: '#00FF00',
                        style: {
                            color: '#FFFFFF'
                        }
                    }
                ]
            });
        }

        // 綁定按鈕點擊事件
        document.getElementById("fetchButton").addEventListener("click", fetchData);
    </script>
</body>
</html>
